<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Upgrading the OpenACS files</title><meta name="generator" content="DocBook XSL Stylesheets V1.66.1"><link rel="home" href="index.html" title="OpenACS Core Documentation"><link rel="up" href="upgrade.html" title="Chapter 5. Upgrading"><link rel="previous" href="upgrade-5-0-dot.html" title="Upgrading 5.0.0 to 5.0.x or 5.1.x"><link rel="next" href="upgrade-supporting.html" title="Upgrading Platform components"><link rel="stylesheet" href="openacs.css" type="text/css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><a href="http://openacs.org"><img src="/doc/images/alex.jpg" border="0" alt="Alex logo"></a><table width="100%" summary="Navigation header" border="0"><tr><td width="20%" align="left"><a accesskey="p" href="upgrade-5-0-dot.html">Prev</a> </td><th width="60%" align="center">Chapter 5. Upgrading</th><td width="20%" align="right"> <a accesskey="n" href="upgrade-supporting.html">Next</a></td></tr></table><hr></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="upgrade-openacs-files"></a>Upgrading the OpenACS files</h2></div></div></div><p>OpenACS is distributed as a collection of files, available as one big tarball, via CVS, and via automatic download from within the APM.  Upgrades work by first changing the file system (via any of the previous methods), and then using the APM to scan the file system, find upgrade scripts, and execute them.  This section describes how to upgrade the file system.  Starting with OpenACS 5.0, this section can generally be skipped because the OpenACS APM can directly download new files from the openacs.org repository.</p><p>Many OpenACS site developers operate their own CVS repository to keep track of changes from the release OpenACS code.  This part describes how to import the latest OpenACS version into your own repository.  If you are using CVS, you will unpack the OpenACS 5.1 tarball into a working directory and then import that directory into cvs.  If you have changed files in the core packages, cvs will attempt to merge your changes.  You may have to manually merge some conflicts.  When that's finished, you can update your normal development checkout directory and the new files will appear.  If you aren't using CVS, you can unpack the tarball on top of your existing tree, but any customizations you've made to the kernel or core packages will be erased.</p><div class="itemizedlist"><ul type="disc"><li><p><b>Upgrading files for a site which is not in a CVS repository. </b>Unpack the tarball into a new directory and copy its contents on top of your working directory.</p><pre class="screen">[root root]# <b class="userinput"><tt>su - <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span></tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cd /var/lib/aolserver</tt></b>
[$OPENACS_SERVICE_NAME web]$ <b class="userinput"><tt>tar xzf /tmp/openacs-5-1.tar.gz</tt></b>
[$OPENACS_SERVICE_NAME web]$ <b class="userinput"><tt>cp -r openacs-5-1/* openacs-4</tt></b>
[$OPENACS_SERVICE_NAME openacs-upgrade]$ <b class="userinput"><tt>exit</tt></b>
[root root]#
<span class="action"><span class="action">su - <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span>
cd /var/lib/aolserver
tar xzf /tmp/openacs-5-1.tgz
cp -r openacs-5-1/* openacs-4
exit</span></span></pre></li><li><p>
          <span class="strong">Upgrading files for a site in a private CVS repository</span>
        </p><div class="figure"><a name="id2545074"></a><p class="title"><b>Figure 5.2. Upgrading a local CVS repository</b></p><div class="mediaobject" align="center"><img src="install-guide/images/upgrade-cvs.png" align="middle" alt="Upgrading a local CVS repository"></div></div><div class="itemizedlist"><ul type="circle"><li><p><b>Step 1: Import new CVS code. </b>There are two common ways to get new OpenACS code into your local CVS repository - via tarball or with a working CVS checkout of OpenACS.  Both methods work well for starting your local repository; the second method is better for incremental additions or upgrades.</p><div class="itemizedlist"><ul type="disc"><li><p><b>(a): via tarball. </b>Download a <a href="http://openacs.org/projects/openacs/download" target="_top">current tarball</a> and unpack the new files into a working directory.</p><pre class="screen">[root root]# <b class="userinput"><tt>su - <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span></tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cd /tmp</tt></b>
[$OPENACS_SERVICE_NAME tmp]$ <b class="userinput"><tt>tar xzf <span class="replaceable"><span class="replaceable">openacs-5-1</span></span>.tar.gz</tt></b>
[$OPENACS_SERVICE_NAME tmp]$ <b class="userinput"><tt>cd <span class="replaceable"><span class="replaceable">openacs-5-1</span></span></tt></b></pre></li><li><p><b>(b): via cvs working checkout. </b>Create a CVS checkout from OpenACS.  The first time you do this, you will need to create the checkout directory.  We use one dedicated directory for each branch of OpenACS - if you are using OpenACS 5.0,x, you only need an OpenACS 5.0 branch.  The <span class="replaceable"><span class="replaceable">openacs-5-1-compat</span></span> tag identifies the latest released version of OpenACS 5.1 (ie, 5.1.3 or 5.1.4) and the latest compatible version of each package, including .LRN.  Each minor release of OpenACS since 5.0 has this tagging structure.  For example, OpenACS 5.1.x has <tt class="computeroutput">openacs-5-1-compat</tt>.
                  You will want to separately check out all the
                  packages you are using.
                </p><pre class="screen">[root root]# <b class="userinput"><tt>su - <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span></tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cd /var/lib/aolserver</tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cvs -d :pserver:anonymous@cvs.openacs.org:/cvsroot checkout -r <span class="replaceable"><span class="replaceable">openacs-5-1-compat</span></span> acs-core</tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cd openacs-4/packages</tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cvs -d :pserver:anonymous@cvs.openacs.org:/cvsroot checkout -r <span class="replaceable"><span class="replaceable">openacs-5-1-compat</span></span> <span class="replaceable"><span class="replaceable">packagename packagename2...</span></span></tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cd ../..</tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>mv openacs-4 <span class="replaceable"><span class="replaceable">openacs-5-1</span></span></tt></b></pre><p>If this checkout already exists, you can simply update it instead of recreating it.</p><pre class="screen">[root root]# <b class="userinput"><tt>su - <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span></tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">openacs-5-1</span></span></tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cvs up -Pd</tt></b></pre></li><li><p><b>(c) A single package via cvs working checkout. </b>You can add or upgrade a single package at a time, if you already have a cvs working directory.</p><pre class="screen">[root root]# <b class="userinput"><tt>su - <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span></tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">openacs-5-1</span></span></tt></b>
[$OPENACS_SERVICE_NAME openacs-5-1]$ <b class="userinput"><tt>cvs up -d <span class="replaceable"><span class="replaceable">myfirstpackage</span></span></tt></b></pre><p>In the next section, the import must be tailored to just this package.</p></li></ul></div></li><li><p><b>Step 2: Merge New OpenACS code. </b>Now that you have a local copy of the new OpenACS code, you need to import it into your local CVS repository and resolve any conflicts that occur.</p><p>Import the new files into your cvs repository; where they match existing files, they will become the new version of the file.</p><pre class="screen">[$OPENACS_SERVICE_NAME openacs-5-1]$ <b class="userinput"><tt> cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">openacs-5-1</span></span></tt></b>
[$OPENACS_SERVICE_NAME openacs-5-1]$ <b class="userinput"><tt> cvs -d /var/lib/cvs import -m "upgrade to OpenACS 5.1" <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span> OpenACS <span class="replaceable"><span class="replaceable">openacs-5-1</span></span></tt></b>
            </pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>If adding or upgrading a single package, run the cvs import from within the base directory of that package, and adjust the cvs command accordingly.  In this example, we are adding the <tt class="computeroutput">myfirstpackage</tt> package.</p><pre class="screen">[root root]# <b class="userinput"><tt>su - <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span></tt></b>
[$OPENACS_SERVICE_NAME aolserver]$ <b class="userinput"><tt>cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">openacs-5-0</span></span>/package/<span class="replaceable"><span class="replaceable">myfirstpackage</span></span></tt></b>
[$OPENACS_SERVICE_NAME myfirstpackage]$ <b class="userinput"><tt>cvs -d /var/lib/cvs/ import -m "importing package" <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span>/packages/<span class="replaceable"><span class="replaceable">myfirstpackage</span></span> OpenACS openacs-5-1</tt></b></pre></div><p>Create a new directory as temporary working space to reconcile conflicts between the new files and your current work.  The example uses the cvs keyword yesterday, making the assumption that you haven't checked in new code to your local tree in the last day.</p><pre class="screen">[$OPENACS_SERVICE_NAME openacs-5.1]$ <b class="userinput"><tt> cd /var/lib/aolserver</tt></b>
[$OPENACS_SERVICE_NAME tmp]$ <b class="userinput"><tt>mkdir <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span>-upgrade</tt></b>
[$OPENACS_SERVICE_NAME tmp]$ <b class="userinput"><tt>cvs checkout -d openacs-upgrade -jOpenACS:yesterday -jOpenACS -kk <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span> &gt; cvs.txt 2&gt;&amp;1</tt></b>
(CVS feedback here)</pre><p>The file /tmp/openacs-upgrade/cvs.txt contains the results of the upgrade.  If you changed files that are part of the OpenACS tarball and those changes conflict, you'll have to manually reconcile them.  Use the emacs command <tt class="computeroutput">M-x sort-lines</tt> and then, for each line that starts with a C, open that file and manually resolve the conflict by deleting the excess lines.  When you're finished, or if there aren't any conflicts, save and exit.</p><p>Once you've fixed any conflicts, commit the new code
            to your local tree.  </p><pre class="screen">[$OPENACS_SERVICE_NAME tmp]$ <b class="userinput"><tt>cd openacs-upgrade</tt></b>
[$OPENACS_SERVICE_NAME openacs-upgrade]$ <b class="userinput"><tt>cvs commit -m "Upgraded to 5.1"</tt></b></pre></li><li><p><b>Step 3: Upgrade your local staging site. </b>Update your working tree with the new files.  The CVS flags ensure that new directories are created and pruned directories destroyed.</p><pre class="screen">[$OPENACS_SERVICE_NAME openacs-upgrade]$ <b class="userinput"><tt>cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span></tt></b>
[$OPENACS_SERVICE_NAME $OPENACS_SERVICE_NAME]$ <b class="userinput"><tt>cvs up -Pd</tt></b>
(CVS feedback)
[$OPENACS_SERVICE_NAME $OPENACS_SERVICE_NAME]$ <b class="userinput"><tt>exit</tt></b>
[root root]# </pre></li></ul></div></li></ul></div><p>
        <span class="strong">Upgrading files for a site using the OpenACS CVS repository (cvs.openacs.org)</span>
      </p><div class="orderedlist"><ol type="1"><li><pre class="screen">[$OPENACS_SERVICE_NAME ~]$ <b class="userinput"><tt>cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span></tt></b>
[$OPENACS_SERVICE_NAME $OPENACS_SERVICE_NAME]$ <b class="userinput"><tt>cvs up -Pd</tt></b>
(CVS feedback)
[$OPENACS_SERVICE_NAME $OPENACS_SERVICE_NAME]$</pre></li></ol></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2545488"></a>Upgrading a Production Site Safely</h3></div></div></div><p>If you are upgrading a production OpenACS site which is on a private CVS tree, this process lets you do the upgrade without risking extended downtime or an unusable site:</p><div class="orderedlist"><ol type="1"><li><p>Declare a freeze on new cvs updates - ie, you cannot run cvs update
   on the production site</p></li><li><p>
            Make a manual backup of the production site in addition to the
   automated backups</p></li><li><p>Import the new code (for example, OpenACS 5.0.4, openacs-5-0-compat versions of
   ETP, blogger, and other applications) into a "vendor branch" of the
   <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span> CVS tree, as described in "Upgrading a local CVS repository", step 1, above. 
   As soon as we do this, any cvs update command on production might bring new code onto the production site, which
   would be bad.</p><p>Do step 2 above (merging conflicts in a <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span>-upgrade working tree).</p></li><li><p>
            Manually resolve any conflicts in the working upgrade tree
          </p></li><li><p>Use the upgrade script and a recent backup of the production database, to ake
  a new upgraded database called <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span>-upgrade.  Now we
   have a new website called <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span>-upgrade.
          </p></li><li><p>
            Test the <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span>-upgrade site
          </p></li><li><p>If <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span>-upgrade is fully functional, do the real upgrade.</p><div class="orderedlist"><ol type="a"><li><p>Take down the <span class="replaceable"><span class="replaceable">$OPENACS_SERVICE_NAME</span></span> site and put up a "down for maintenance" page.</p></li><li><p>Repeat the upgrade with the most recent database</p></li><li><p>Test the that the new site is functional.  If so, change the upgraded site to respond to
               <span class="replaceable"><span class="replaceable">yourserver.net</span></span> requests. If not, bring the original production site back up and return to the merge.</p></li></ol></div></li></ol></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="upgrade-5-0-dot.html">Prev</a> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right"> <a accesskey="n" href="upgrade-supporting.html">Next</a></td></tr><tr><td width="40%" align="left">Upgrading 5.0.0 to 5.0.x or 5.1.x </td><td width="20%" align="center"><a accesskey="u" href="upgrade.html">Up</a></td><td width="40%" align="right"> Upgrading Platform components</td></tr></table><hr><address><a href="mailto:docs@openacs.org">docs@openacs.org</a></address></div><a name="comments"></a><center><a href="http://openacs.org/doc/current/upgrade-openacs-files.html#comments">View comments on this page at openacs.org</a></center></body></html>
